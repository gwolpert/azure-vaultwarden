name: Destroy Vaultwarden Infrastructure

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to destroy'
        required: true
        type: environment
      confirm:
        description: 'Type the environment name to confirm deletion'
        required: true
        type: string

permissions:
  id-token: write
  contents: read

jobs:
  validate:
    name: Validate deletion request
    runs-on: ubuntu-latest
    steps:
      - name: Validate confirmation
        run: |
          if [ "${{ inputs.confirm }}" != "${{ inputs.environment }}" ]; then
            echo "âŒ Confirmation failed: '${{ inputs.confirm }}' does not match '${{ inputs.environment }}'"
            exit 1
          fi
          echo "âœ… Confirmation validated"

  destroy:
    name: Destroy ${{ inputs.environment }}
    runs-on: ubuntu-latest
    needs: validate
    environment: ${{ inputs.environment }}
    
    steps:
      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Delete Resource Group
        run: |
          RG_NAME="${{ vars.RESOURCE_GROUP_NAME }}"
          
          echo "Checking if resource group exists..."
          if az group exists --name "$RG_NAME" | grep -q "true"; then
            echo "Deleting resource group: $RG_NAME"
            az group delete --name "$RG_NAME" --yes --no-wait
            
            echo "### Resource Group Deletion Initiated ðŸ—‘ï¸" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Resource Group:** $RG_NAME" >> $GITHUB_STEP_SUMMARY
            echo "**Status:** Deletion in progress (async)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸ Note: Deletion is running in the background and may take several minutes to complete." >> $GITHUB_STEP_SUMMARY
          else
            echo "Resource group $RG_NAME does not exist"
            echo "### Resource Group Not Found â„¹ï¸" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Resource Group:** $RG_NAME" >> $GITHUB_STEP_SUMMARY
            echo "**Status:** Does not exist (nothing to delete)" >> $GITHUB_STEP_SUMMARY
          fi
